Script to collect EXPLAIN ANALYZE plans for documentation
Save output to docs/explain_plans.txt

TEST 1: Date Search (Before and After)

TEST 1: DATE SEARCH
BEFORE optimization (no index):
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT) 
SELECT * FROM shipments 
WHERE created_at::text LIKE '2024-05%'
LIMIT 1000;

AFTER optimization (with index):
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT) 
SELECT * FROM shipments 
WHERE created_at >= '2024-05-01'::timestamp
AND created_at < '2024-06-01'::timestamp
LIMIT 1000;

TEST 2: Driver Search (Before and After)
TEST 2: DRIVER SEARCH
BEFORE normalization:
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT) 
SELECT * FROM shipments 
WHERE driver_details LIKE '%Smith%'
LIMIT 1000;

AFTER normalization (with join):
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT) 
SELECT s.* 
FROM shipments s
JOIN drivers d ON s.driver_id = d.driver_id
WHERE d.driver_name ILIKE '%Smith%'
LIMIT 1000;

TEST 3: JSON Query (Before and After)
TEST 3: JSON QUERY
BEFORE JSONB conversion:
Note: Only run this if raw_invoice_data still exists
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT) 
SELECT * FROM finance_invoices 
WHERE CAST(raw_invoice_data::json->>'amount_cents' AS INT) > 50000
LIMIT 1000;

AFTER JSONB with GIN index:
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT) 
SELECT * FROM finance_invoices 
WHERE (invoice_data->>'amount_cents')::INTEGER > 50000
LIMIT 1000;

TEST 4: Telemetry Query (Before and After)
TEST 4: TELEMETRY PARTITIONING
AFTER partitioning (showing partition pruning):
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT) 
SELECT * FROM truck_telemetry 
WHERE truck_license_plate = 'ABC-123' 
AND timestamp > '2024-06-01'
ORDER BY timestamp DESC 
LIMIT 100;

TEST 5: Analytics (Materialized View)
TEST 5: ANALYTICS MATERIALIZED VIEW
Direct query (slow):
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT) 
SELECT 
    COUNT(*) FILTER (WHERE status='DELIVERED') as delivered,
    (SELECT AVG(speed) FROM truck_telemetry) as avg_speed
FROM shipments;

Materialized view query (fast):
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT) 
SELECT delivered_count, avg_speed, total_revenue_cents
FROM analytics_dashboard
LIMIT 1;

Index Usage Statistics
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan as index_scans,
    idx_tup_read as tuples_read,
    idx_tup_fetch as tuples_fetched
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;

Table and Index Sizes
STORAGE ANALYSIS
SELECT 
    tablename,
    pg_size_pretty(pg_total_relation_size('public.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size('public.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size('public.'||tablename) - 
                   pg_relation_size('public.'||tablename)) AS indexes_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size('public.'||tablename) DESC;